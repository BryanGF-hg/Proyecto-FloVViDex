<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard – FloMViDex</title>
  <style>
/* Generales */
 body {font-family: Arial, sans-serif; margin:20px; background:linear-gradient(135deg,#fff,#ffb3d133); color:#222;}
header {display:flex; flex-wrap:wrap; justify-content:space-between; gap:20px; margin-bottom:5px; align-items:flex-start;}
h1,h2,h3 {color:#0f8b8d;}

/* Directorios */
.tabs {display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
.tab {padding:8px 12px; border-radius:6px; cursor:pointer;  background:#fff; color:#0f8b8d; border:2px solid #3fe0d0; transition:.2s;}
.tab.active {background:linear-gradient(135deg,#3fe0d0,#0f8b8d); font-weight:bold; box-shadow:0 0 10px #3fe0d0aa;}

/* Motor de Busqueda */
.filters {margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;}
.filters input, .filters select {padding:6px 8px; font-size:14px; border-radius:6px; border:1px solid #0f8b8d55; color:#0f8b8d;}

/* Formulario CREATE */
form {display:flex; flex-direction:column; gap:8px; margin-top:10px;}
form input[type=text], form input[type=file] {padding:6px 8px; border-radius:6px; border:1px solid #0f8b8d55;}
form button {padding:6px 12px; font-size:14px; cursor:pointer; border-radius:8px;  border:2px solid #ffd86b;
  background:linear-gradient(135deg,#ffd86b,#ffb3d1);  font-weight:bold; color:#222; transition:.2s;}
form button:hover {background:linear-gradient(135deg,#ffb3d1,#ffd86b); }
/* Tabla */
table {width:100%; border-collapse:collapse; margin-top:10px;  background:#fff8; border-radius:10px; overflow:hidden;box-shadow:0 8px 20px #0f8b8d22;animation:wave 8s linear infinite;}
th,td{border:1px solid #0f8b8d33; padding:8px; font-size:14px;}
th {background:#3fe0d033;color:#0f8b8d;font-weight:bold;}
.actions button {margin-right:5px; padding:4px 8px; font-size:12px;  border-radius:5px; cursor:pointer; border:none; color:#fff;  background:#3fe0d0; transition:.2s;}
.actions button:hover {background:#0f8b8d;}
.no-data {text-align:center; color:#ff5fa2; font-style:italic;}

/* PLAYER */
#player-info {font-size:13px; color:#0f8b8d; margin-bottom:6px;}
#header-player {width:100%;border:3px solid #ffd86b; border-radius:12px;animation:led 2.2s infinite ease-in-out;} 
  </style>
</head>
<body>
  <div class="page">
    <header>
      <!-- Texto + directorios + buscador con filtros -->
      <div class="divider" style="flex: 2 1 320px;">
        <h1>Admin Dashboard para FloMViDex</h1>
        <div id="current-directory-label">
          <h3>Directorio actual:</h3>
        </div>
         <span id="directory-stats"></span>          

        <div class="tabs">
          <div class="tab active" data-dir="mc1">maidcore 1.0</div>
          <div class="tab" data-dir="mc2">maidcore 2.0</div>
          <div class="tab" data-dir="mc3">maidcore 3.0</div>
          <div class="tab" data-dir="mc4">maidcore 4.0</div>
        </div>

        <div class="filters">
          <input type="text" id="search-input" placeholder="Buscar por título, archivo, artista o tag...">
          <select id="extension-filter">
            <option value="all">Todas las extensiones</option>
            <option value="mp3">Solo .mp3</option>
          </select>
        </div>
      </div>

      <!-- Reproductor -->
      <div class="divider" style="flex: 1 1 260px;">
        <h2>Reproductor básico</h2>
        <div id="player-info"></div>
        <audio id="header-player" controls>
          Tu navegador no soporta el elemento de audio.
        </audio>
      </div>

      <!-- CREATE -->
      <div class="divider" style="flex: 1 1 260px;">
        <h2>Crear nuevo track</h2>
        <form id="create-form">
          <input type="text" name="title" placeholder="[OPCIONAL] Título base del track">
          <input type="text" name="artist" placeholder="[OPCIONAL] Artista">
          <input type="text" name="tags" placeholder="[OPCIONAL] Tags (coma, separadas)">
          <input type="file" name="file" accept="audio/" multiple required>
          <button type="submit">Subir</button>
        </form>
      </div>
    </header>

    <div id="table-toolbar">
      <button id="delete-selected-btn">Eliminar seleccionados</button>
      <button id="export-json-btn">Exportar JSON del directorio</button>
    </div>

    <table id="tracks-table">
      <thead>
        <tr>
          <th class="select-col"><input type="checkbox" id="select-all"></th>
          <th>ID</th>
          <th>Título</th>
          <th>Artista</th>
          <th>Tags</th>
          <th>Archivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const LS_KEY = 'flomvidex_tracks_v1';
    const emptyTracks = () => ({mc1:[],mc2:[],mc3:[],mc4:[]});
    let tracksByDirectory = {};
    let nextIdByDirectory = {};
    const computeNextIds = obj => {
      const res = {};
      Object.keys(obj).forEach(dir => {
        const arr = obj[dir] || [];
        res[dir] = (arr.reduce((m,t)=>Math.max(m,t.id||0),0))+1;
      });
      return res;
    };

    const saveLS = () => {
      try { localStorage.setItem(LS_KEY, JSON.stringify(tracksByDirectory)); }
      catch(e){ console.error(e); }
    };
    const loadLS = () => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        tracksByDirectory = raw ? JSON.parse(raw) : emptyTracks();
        const base = emptyTracks();
        Object.keys(base).forEach(d => { if (!tracksByDirectory[d]) tracksByDirectory[d]=[]; });
      } catch(e) {
        tracksByDirectory = emptyTracks();
      }
      nextIdByDirectory = computeNextIds(tracksByDirectory);
      saveLS();
    };
    loadLS();

    let currentDirectory = 'mc1';
    const tabs = document.querySelectorAll('.tab');
    const tableBody = document.querySelector('#tracks-table tbody');
    const dirLabel = document.getElementById('current-directory-label');
    const createForm = document.getElementById('create-form');
    const searchInput = document.getElementById('search-input');
    const extensionFilter = document.getElementById('extension-filter');
    const headerPlayer = document.getElementById('header-player');
    const playerInfo = document.getElementById('player-info');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const selectAllCheckbox = document.getElementById('select-all');

    const updateDirectoryLabel = () => {
      const total = (tracksByDirectory[currentDirectory]||[]).length;
      dirLabel.innerHTML = '<h3>Directorio actual:</h3> ' + currentDirectory + ' · Tracks: ' + total;
    };

    const playInHeader = track => {
      headerPlayer.src = track.file;
      headerPlayer.play().catch(()=>{});
      playerInfo.textContent = (track.title||'Sin título') + ' – ' + (track.artist||'') + ' (' + track.file + ')';
    };

    const deleteTrack = id => {
      const arr = tracksByDirectory[currentDirectory];
      const i = arr.findIndex(t => t.id===id);
      if (i>-1) {
        arr.splice(i,1);
        saveLS();
        loadTracks();
      }
    };

    const loadTracks = () => {
      tableBody.innerHTML = '';
      const all = tracksByDirectory[currentDirectory] || [];
      const term = searchInput.value.trim().toLowerCase();
      const ext = extensionFilter.value;

      const filtered = all.filter(t => {
        const title = (t.title||'').toLowerCase();
        const file = (t.file||'').toLowerCase();
        const artist = (t.artist||'').toLowerCase();
        const tagsText = Array.isArray(t.tags) ? t.tags.join(' ').toLowerCase() : (t.tags||'').toLowerCase();
        const textMatch = !term || title.includes(term) || file.includes(term) || artist.includes(term) || tagsText.includes(term);
        const extMatch = ext==='all' ? true : file.split('.').pop()===ext;
        return textMatch && extMatch;
      });
// Casillas en blanco, importante para no borrar
      if (selectAllCheckbox) selectAllCheckbox.checked = false;

      if (!filtered.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.textContent = 'No hay tracks en este directorio con el filtro actual.';
        cell.className = 'no-data';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      filtered.forEach(track => {
        const row = document.createElement('tr');

        const selectCell = document.createElement('td');
        selectCell.className = 'select-col';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'row-select';
        cb.dataset.id = track.id;
        selectCell.appendChild(cb);

        const idCell = document.createElement('td');
        idCell.textContent = track.id;

        const titleCell = document.createElement('td');
        titleCell.textContent = track.title;
        titleCell.addEventListener('dblclick', () => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = track.title;
          input.className = 'title-edit-input';
          titleCell.textContent = '';
          titleCell.appendChild(input);
          input.focus();
          const save = () => {
            const val = input.value.trim();
            if (val) {
              track.title = val;
              saveLS();
            }
            loadTracks();
          };
          input.addEventListener('blur', save);
          input.addEventListener('keydown', e => {
            if (e.key==='Enter') input.blur();
            if (e.key==='Escape') loadTracks();
          });
        });

        const artistCell = document.createElement('td');
        artistCell.textContent = track.artist || '-';

        const tagsCell = document.createElement('td');
        tagsCell.textContent = Array.isArray(track.tags) ? track.tags.join(', ') : (track.tags||'-');

        const fileCell = document.createElement('td');
        fileCell.textContent = track.file;

        const actionsCell = document.createElement('td');
        actionsCell.className = 'actions';
        const playBtn = document.createElement('button');
        playBtn.textContent = 'Reproducir';
        playBtn.addEventListener('click', () => playInHeader(track));
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.addEventListener('click', () => deleteTrack(track.id));
        actionsCell.appendChild(playBtn);
        actionsCell.appendChild(deleteBtn);

        row.appendChild(selectCell);
        row.appendChild(idCell);
        row.appendChild(titleCell);
        row.appendChild(artistCell);
        row.appendChild(tagsCell);
        row.appendChild(fileCell);
        row.appendChild(actionsCell);
        tableBody.appendChild(row);
      });

      updateDirectoryLabel();
    };

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentDirectory = tab.dataset.dir;
        if (!tracksByDirectory[currentDirectory]) {
          tracksByDirectory[currentDirectory] = [];
          nextIdByDirectory[currentDirectory] = 1;
          saveLS();
        }
        loadTracks();
      });
    });

    createForm.addEventListener('submit', e => {
      e.preventDefault();
      const fd = new FormData(createForm);
      const titleBase = (fd.get('title')||'').trim();
      const artistBase = (fd.get('artist')||'').trim();
      const tagsRaw = (fd.get('tags')||'').trim();
      const files = fd.getAll('file');
      if (!files || !files.length) return;
      if (!tracksByDirectory[currentDirectory]) {
        tracksByDirectory[currentDirectory] = [];
        nextIdByDirectory[currentDirectory] = 1;
      }
      const tagsArray = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];
      files.forEach((file,i) => {
        if (!file || !file.name) return;
        const title = titleBase ? (files.length>1 ? `${titleBase} (${i+1})` : titleBase) : file.name;
        tracksByDirectory[currentDirectory].push({
          id: nextIdByDirectory[currentDirectory]++,
          title,
          file: file.name,
          artist: artistBase || '',
          tags: tagsArray
        });
      });
      saveLS();
      createForm.reset();
      loadTracks();
    });

    if (deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', () => {
        const checked = document.querySelectorAll('.row-select:checked');
        if (!checked.length) return;
        const ids = Array.from(checked).map(cb => parseInt(cb.dataset.id,10));
        tracksByDirectory[currentDirectory] =
          (tracksByDirectory[currentDirectory]||[]).filter(t => !ids.includes(t.id));
        saveLS();
        loadTracks();
      });
    }

    if (exportJsonBtn) {
      exportJsonBtn.addEventListener('click', () => {
        const data = tracksByDirectory[currentDirectory] || [];
        console.log('JSON exportado para', currentDirectory, JSON.stringify(data,null,2));
        alert('JSON del directorio exportado a la consola (F12).');
      });
    }

    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', () => {
        document.querySelectorAll('.row-select').forEach(cb => cb.checked = selectAllCheckbox.checked);
      });
    }

    searchInput.addEventListener('input', loadTracks);
    extensionFilter.addEventListener('change', loadTracks);

    // Inicializar
    loadTracks();
  </script>
</body>
</html>
