<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard – FloMViDex</title>
  <style>
/* Generales */
 body {font-family: Arial, sans-serif; margin:20px; background:linear-gradient(135deg,#fff,#ffb3d133); color:#222;}
header {display:flex; flex-wrap:wrap; justify-content:space-between; gap:20px; margin-bottom:5px; align-items:flex-start;}
h1,h2,h3 {color:#0f8b8d;}

/* Directorios */
.tabs {display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
.tab {padding:8px 12px; border-radius:6px; cursor:pointer;  background:#fff; color:#0f8b8d; border:2px solid #3fe0d0; transition:.2s;}
.tab.active {background:linear-gradient(135deg,#3fe0d0,#0f8b8d); font-weight:bold; box-shadow:0 0 10px #3fe0d0aa;}

/* Motor de Busqueda */
.filters {margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;}
.filters input, .filters select {padding:6px 8px; font-size:14px; border-radius:6px; border:1px solid #0f8b8d55; color:#0f8b8d;}

/* Formulario CREATE */
form {display:flex; flex-direction:column; gap:8px; margin-top:10px;}
form input[type=text], form input[type=file] {padding:6px 8px; border-radius:6px; border:1px solid #0f8b8d55;}
form button {padding:6px 12px; font-size:14px; cursor:pointer; border-radius:8px;  border:2px solid #ffd86b;width:100%;
  background:linear-gradient(135deg,#ffd86b,#ffb3d1);  font-weight:bold; color:#222; transition:.2s;}
form button:hover {background:linear-gradient(135deg,#ffb3d1,#ffd86b); }

table {width:100%; border-collapse:collapse; margin-top:10px;  background:#fff8; border-radius:10px; overflow:hidden;box-shadow:0 8px 20px #0f8b8d22;animation:wave 8s linear infinite;}

@keyframes wave {{  from {{ background-position:0 0; }}  to {{ background-position:400px 0; }}}}

th,td{border:1px solid #0f8b8d33; padding:8px; font-size:14px;}
th {background:#3fe0d033;color:#0f8b8d;font-weight:bold;}

.actions button {margin-right:5px; padding:4px 8px; font-size:12px;  border-radius:5px; cursor:pointer; border:none; color:#fff;  background:#3fe0d0; transition:.2s;}
.actions button:hover {background:#0f8b8d;}

.no-data {text-align:center; color:#ff5fa2; font-style:italic;}

#player-info {font-size:13px; color:#0f8b8d; margin-bottom:6px;}
#header-player {width:100%;border:3px solid #ffd86b; border-radius:12px;animation:led 2.2s infinite ease-in-out;} 
  </style>
</head>
<body>
  <div class="page">
    <header>
      <!-- Divider 1: Texto + tabs + filtros -->
      <div class="divider" style="flex: 2 1 320px;">
        <h1>Admin Dashboard para FloMViDex</h1>
        <div id="current-directory-label">
          <h3>Directorio actual:</h3>
        </div>
         <span id="directory-stats"></span>  
                  
        <div class="tabs">
          <div class="tab active" data-dir="mc1">maidcore 1.0</div>
          <div class="tab" data-dir="mc2">maidcore 2.0</div>
          <div class="tab" data-dir="mc3">maidcore 3.0</div>
          <div class="tab" data-dir="mc4">maidcore 4.0</div>
        </div>

        <!-- Filtros / búsqueda -->
        <div class="filters">
          <input
            type="text"
            id="search-input"
            placeholder="Buscar por título, archivo, artista o tag..."
          >
          <select id="extension-filter">
            <option value="all">Todas las extensiones</option>
            <option value="mp3">Solo .mp3</option>
          </select>
        </div>
      </div>

      <!-- Divider 2: Reproductor básico -->
      <div class="divider" style="flex: 1 1 260px;">
        <h2>Reproductor básico</h2>
        <div id="player-info">Ningún track seleccionado</div>
        <audio id="header-player" controls>
          Tu navegador no soporta el elemento de audio.
        </audio>
      </div>

      <!-- Divider 3: Creación de tracks -->
      <div class="divider" style="flex: 1 1 260px;">
        <h2>Crear nuevo track</h2>
        <form id="create-form">
          <input type="text" name="title" placeholder="Título base del track (opcional)">
          <input type="text" name="artist" placeholder="Artista (opcional)">
          <input type="text" name="tags" placeholder="Tags (coma, separadas, opcional)">
          <!-- multiple = creación múltiple de mp3 -->
          <input type="file" name="file" accept=".mp3" multiple required>
          <label class="inline">
          <button type="submit">Subir</button>
        </form>
      </div>
    </header>

    <!-- Toolbar de la tabla -->
    <div id="table-toolbar">
      <button id="delete-selected-btn">Eliminar seleccionados</button>
      <button id="export-json-btn">Exportar JSON del directorio</button>
    </div>

    <!-- Tabla de tracks -->
    <table id="tracks-table">
      <thead>
        <tr>
          <th class="select-col">
            <input type="checkbox" id="select-all">
          </th>
          <th>ID</th>
          <th>Título</th>
          <th>Artista</th>
          <th>Tags</th>
          <th>Archivo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Clave de localStorage
    const LS_KEY = 'flomvidex_tracks_v1';
    // Estructura vacía (sin tracks por defecto)
    function getEmptyTracksStructure() {
      return {
        mc1: [],
        mc2: [],
        mc3: [],
        mc4: []
      };
    }
    // Variables principales
    let tracksByDirectory = {};
    let nextIdByDirectory = {};

    // Calcula el siguiente ID por directorio según lo que haya en memoria
    function computeNextIdByDirectory(tracksObj) {
      const result = {};
      Object.keys(tracksObj).forEach(dir => {
        const arr = tracksObj[dir] || [];
        const maxId = arr.reduce((max, t) => Math.max(max, t.id || 0), 0);
        result[dir] = maxId + 1;
      });
      return result;
    }

    function saveToLocalStorage() {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(tracksByDirectory));
      } catch (e) {
        console.error('No se pudo guardar en localStorage:', e);
      }
    }
    function loadFromLocalStorageOrEmpty() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) {
          // Primera vez: estructura vacía
          tracksByDirectory = getEmptyTracksStructure();
          nextIdByDirectory = computeNextIdByDirectory(tracksByDirectory);
          saveToLocalStorage();
        } else {
          const parsed = JSON.parse(raw);
          tracksByDirectory = parsed && typeof parsed === 'object'
            ? parsed
            : getEmptyTracksStructure();

          // Asegurar directorios base
          const base = getEmptyTracksStructure();
          Object.keys(base).forEach(dir => {
            if (!tracksByDirectory[dir]) {
              tracksByDirectory[dir] = [];
            }
          });

          nextIdByDirectory = computeNextIdByDirectory(tracksByDirectory);
        }
      } catch (e) {
        console.warn('Error leyendo localStorage, usando datos vacíos:', e);
        tracksByDirectory = getEmptyTracksStructure();
        nextIdByDirectory = computeNextIdByDirectory(tracksByDirectory);
        saveToLocalStorage();
      }
    }
    // Inicializar datos dinámicos
    loadFromLocalStorageOrEmpty();

////////////////////////////////////
// Selector de cambios entre tablas
////////////////////////////////////
    let currentDirectory = 'mc1';
    // Elementos del DOM
    const tabs = document.querySelectorAll('.tab');
    const tableBody = document.querySelector('#tracks-table tbody');
    const dirLabel = document.getElementById('current-directory-label');
    const createForm = document.getElementById('create-form');
    const searchInput = document.getElementById('search-input');
    const extensionFilter = document.getElementById('extension-filter');
    const headerPlayer = document.getElementById('header-player');
    const playerInfo = document.getElementById('player-info');



    // Toolbar
    const directoryStats = document.getElementById('directory-stats');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const selectAllCheckbox = document.getElementById('select-all');

    // Cambiar de pestaña (directorio)
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentDirectory = tab.dataset.dir;

        if (!tracksByDirectory[currentDirectory]) {
          tracksByDirectory[currentDirectory] = [];
          nextIdByDirectory[currentDirectory] = 1;
          saveToLocalStorage();
        }

        updateDirectoryLabel();
        loadTracks();
      });
    });



    function updateDirectoryLabel() {
      const allTracks = tracksByDirectory[currentDirectory] || [];          
      const totalTracks = allTracks.length;    
      dirLabel.innerHTML = '<h3>Directorio actual:</h3> '+currentDirectory + ' Tracks: ' + totalTracks;
    }

// Cargar tracks en la tabla según directorio + filtros
    function loadTracks() {
      tableBody.innerHTML = '';
      const allTracks = tracksByDirectory[currentDirectory] || [];
      const term = searchInput.value.trim().toLowerCase();
      const extFilter = extensionFilter.value;

      const filtered = allTracks.filter(track => {
        const title = (track.title || '').toLowerCase();
        const file = (track.file || '').toLowerCase();
        const artist = (track.artist || '').toLowerCase();
        const tagsText = Array.isArray(track.tags)
          ? track.tags.join(' ').toLowerCase()
          : (track.tags || '').toLowerCase();

        const textMatch =
          !term ||
          title.includes(term) ||
          file.includes(term) ||
          artist.includes(term) ||
          tagsText.includes(term);

        const hasExt = file.split('.').pop();
        const extMatch = extFilter === 'all' ? true : hasExt === extFilter;

        return textMatch && extMatch;
      });

      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
      }

      if (filtered.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 8;
        cell.textContent = 'No hay tracks en este directorio con el filtro actual.';
        cell.className = 'no-data';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }

      filtered.forEach(track => {
        const row = document.createElement('tr');

// Selección
        const selectCell = document.createElement('td');
        selectCell.className = 'select-col';
        const rowCheckbox = document.createElement('input');
        rowCheckbox.type = 'checkbox';
        rowCheckbox.className = 'row-select';
        rowCheckbox.dataset.id = track.id;
        selectCell.appendChild(rowCheckbox);

// ID
        const idCell = document.createElement('td');
        idCell.textContent = track.id;

// Título (edición rápida)
        const titleCell = document.createElement('td');
        titleCell.textContent = track.title;

        titleCell.addEventListener('dblclick', () => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = track.title;
          input.className = 'title-edit-input';
          titleCell.textContent = '';
          titleCell.appendChild(input);
          input.focus();

          const save = () => {
            const newTitle = input.value.trim();
            if (newTitle !== '') {
              track.title = newTitle;
              saveToLocalStorage();
            }
            loadTracks();
          };

          input.addEventListener('blur', save);
          input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              input.blur();
            } else if (e.key === 'Escape') {
              loadTracks();
            }
          });
        });

// Artista
        const artistCell = document.createElement('td');
        artistCell.textContent = track.artist || '-';
        if (track.artist) {
          artistCell.classList.add('artist-link');
          artistCell.addEventListener('click', () => {
            showArtistCard(track.artist);
          });
        }

// Tags
        const tagsCell = document.createElement('td');
        let tagsText = '';
        if (Array.isArray(track.tags)) {
          tagsText = track.tags.join(', ');
        } else if (typeof track.tags === 'string') {
          tagsText = track.tags;
        }
        tagsCell.textContent = tagsText || '-';

// Archivo
        const fileCell = document.createElement('td');
        fileCell.textContent = track.file;

// Acciones
        const actionsCell = document.createElement('td');
        actionsCell.className = 'actions';

        const playBtn = document.createElement('button');
        playBtn.textContent = 'Reproducir';
        playBtn.addEventListener('click', () => {
          playInHeader(track);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.addEventListener('click', () => {
          deleteTrack(track.id);
        });


//Resto de Cabeceras de la tabla grande
        row.appendChild(selectCell);
        row.appendChild(idCell);
        row.appendChild(titleCell);
        row.appendChild(artistCell);
        row.appendChild(tagsCell);
        row.appendChild(fileCell);
        row.appendChild(actionsCell);
//Acciones dentro de la tabla grande
          actionsCell.appendChild(playBtn);
          actionsCell.appendChild(deleteBtn);

        tableBody.appendChild(row);
      });
    }

// Reproducir track en el reproductor del header
    function playInHeader(track) {
      const src = track.file; // Ajusta a tu ruta real si lo sirves desde un directorio
      headerPlayer.src = src;
      headerPlayer.play().catch(() => {});
      playerInfo.textContent =
        (track.title || 'Sin título') +
        ' – ' +
        (track.artist || '') +
        ' (' +
        track.file +
        ')';
    }

// Eliminar track por ID dentro del directorio actual
    function deleteTrack(id) {
      const tracks = tracksByDirectory[currentDirectory];
      const index = tracks.findIndex(t => t.id === id);
      if (index !== -1) {
        tracks.splice(index, 1);
        saveToLocalStorage();
        loadTracks();
      }
    }

/////////////////////////////
// CREATE
/////////////////////////////
// Crear nuevos tracks (múltiples archivos)
    createForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(createForm);
      const titleBase = (formData.get('title') || '').trim();
      const artistBase = (formData.get('artist') || '').trim();
      const tagsRaw = (formData.get('tags') || '').trim();
      const files = formData.getAll('file');

      if (!files || files.length === 0) return;

      if (!tracksByDirectory[currentDirectory]) {
        tracksByDirectory[currentDirectory] = [];
        nextIdByDirectory[currentDirectory] = 1;
      }

      const tagsArray = tagsRaw
        ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean)
        : [];

      files.forEach((file, index) => {
        if (!file || !file.name) return;

        const title =
          titleBase !== ''
            ? (files.length > 1 ? `${titleBase} (${index + 1})` : titleBase)
            : file.name;

        const newTrack = {
          id: nextIdByDirectory[currentDirectory]++,
          title: title,
          file: file.name,
          artist: artistBase || '',
          tags: [...tagsArray]
        };
        tracksByDirectory[currentDirectory].push(newTrack);
      });

      saveToLocalStorage();
      createForm.reset();
      loadTracks();
    });             // Fin del formulario para el CREATE


///////////////////////////////////////
// Botón "Eliminar seleccionados"
    if (deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.row-select:checked');
        if (!checkboxes.length) return;

        const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id, 10));
        tracksByDirectory[currentDirectory] =
          (tracksByDirectory[currentDirectory] || []).filter(t => !idsToDelete.includes(t.id));
        saveToLocalStorage();
        loadTracks();
      });
    }
///////////////////////////////////////
// Botón "Exportar JSON del directorio"
    if (exportJsonBtn) {
      exportJsonBtn.addEventListener('click', () => {
        const data = tracksByDirectory[currentDirectory] || [];
        const json = JSON.stringify(data, null, 2);
        console.log('JSON exportado para', currentDirectory, json);
        alert('JSON del directorio exportado a la consola (F12).');
      });
    }

    // Checkbox "seleccionar todo"
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', () => {
        const rowCheckboxes = document.querySelectorAll('.row-select');
        rowCheckboxes.forEach(cb => {
          cb.checked = selectAllCheckbox.checked;
        });
      });
    }

// Filtros de BUSQUEDA
    searchInput.addEventListener('input', loadTracks);
    extensionFilter.addEventListener('change', loadTracks);
// Inicializar
    updateDirectoryLabel();
    loadTracks();
  </script>
</body>
</html>
